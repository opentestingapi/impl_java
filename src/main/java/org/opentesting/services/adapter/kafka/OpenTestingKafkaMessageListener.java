package org.opentesting.services.adapter.kafka;

import java.util.List;
import java.util.stream.Collectors;

import org.opentesting.services.execution.TestManager;
import org.opentesting.services.execution.dto.CheckResultDTO;
import org.opentesting.services.execution.dto.TestCaseCheckDTO;
import org.opentesting.services.prometheus.Prometheus;
import org.opentesting.util.OpenTestingConversion;

import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.springframework.kafka.listener.MessageListener;

import lombok.extern.slf4j.Slf4j;

@Slf4j
public class OpenTestingKafkaMessageListener implements MessageListener<String, String> {

    private String connectstring;
    private String connectuser;
    private TestManager testPlaner;
    private String key;
    private Prometheus prometheus;

    public OpenTestingKafkaMessageListener(String connectstring, String connectuser, TestManager testPlaner, String key, Prometheus prometheus) {
        this.connectstring = connectstring;
        this.connectuser = connectuser;
        this.testPlaner = testPlaner;
        this.key = key;
        this.prometheus = prometheus;
    }

    @Override
    public void onMessage(ConsumerRecord<String, String> data) {

        //read checks
        List<TestCaseCheckDTO> checks = testPlaner.getChecksByServiceAndConnectstringAndOpen("kafka", connectstring, connectuser);

        //execute checks in parallel
        List<Boolean> results = checks.parallelStream().map(c -> {
            try {
                return testPlaner.executeCheck(c, false, data.value(), Long.valueOf(data.timestamp()));
            } catch (Exception e) {
                log.error("Kafka - check execution exception: "+e.getMessage(), e);
                return null;
            }
        }).collect(Collectors.toList());

        //prepare result
        CheckResultDTO result = OpenTestingConversion.list2CheckResult(results);        

        //prometheus
        prometheus.incrementExecution("kafkaconsumer", connectstring+"#"+connectuser);

        log.info("##### CHECK ##### kafka " + key + ": total "+checks.size()+" / success "+result.getSuccess()
            +" / failed "+result.getFailed()+" / without "+result.getWithout());
    }

}
