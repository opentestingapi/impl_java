package org.opentesting.services.adapter.jdbc;

import lombok.extern.slf4j.Slf4j;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.time.LocalDateTime;

@Slf4j
public class JdbcConnector {

    private String url;
    private String user;
    private String pw;
    private Connection con;
    private String info;
    private LocalDateTime creation;

    public JdbcConnector(String connectstring, String connectuser, String connectpassword) throws SQLException {

        info = connectstring + '#' + connectuser;

        this.url = connectstring;
        this.user = connectuser;
        this.pw = connectpassword;
        
        connect();
    }

    private void connect() throws SQLException {

        con = DriverManager.getConnection(url,user,pw);

        creation = LocalDateTime.now();

        log.info("Database Connection established: "+getInfo());
    }

    public void close() throws SQLException {
        con.close();
        log.info("Database Connection closed: " + getInfo());
    }

    public Connection getConnection() throws SQLException {

        if(getCreation().isBefore(LocalDateTime.now().plusHours(-1))){
            close();
            connect();
        }
        return con;
    }

    private LocalDateTime getCreation() {
        return creation;
    }

    public String getInfo() {
        return this.info;
    }

}
