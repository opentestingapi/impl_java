package org.opentesting.services.execution;

import java.util.List;

import org.opentesting.services.execution.dto.TestCaseCheckDTO;
import org.opentesting.services.execution.dto.TestCaseDTO;
import org.opentesting.services.execution.persistence.TestCaseCheckRepository;
import org.opentesting.services.execution.persistence.TestCaseFileRepository;
import org.opentesting.services.execution.persistence.TestCaseInjectionRepository;
import org.opentesting.services.execution.persistence.TestCaseRepository;
import org.opentesting.util.LogExecutionTime;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;

/**
 * central reporting logic
 */
@Controller
public class TestReporting {
    
    @Autowired
    private TestCaseFileRepository testCaseFileRepository;

    @Autowired
    private TestCaseCheckRepository testCaseCheckRepository;

    @Autowired
    private TestCaseInjectionRepository testCaseInjectionRepository;

    @Autowired
    private TestCaseRepository testCaseRepository;

    @LogExecutionTime
    public TestCaseDTO getTest(String testid, int lastchecks) {

        //get by ID
        TestCaseDTO test = testCaseRepository.select(testid);

        //extend
        test = this.addInjects(test);
        test = this.addChecks(test, lastchecks);
        test = this.removePasswords(test);
        
        return test;
    }  
    
    /**
     * add injects to the object
     */
    private TestCaseDTO addInjects(TestCaseDTO test) {
        if (test == null) return test;
        test.setInjections(testCaseInjectionRepository.select(test.getTestid()));
        return test;
    }

    /**
     * add checks to the object
     */
    private TestCaseDTO addChecks(TestCaseDTO test, int lastchecks) {
        if (test == null) return test;
        test.setChecks(testCaseCheckRepository.selectLast(test.getTestid(), lastchecks));
        return test;
    }

    @LogExecutionTime
    public String getTestFile(String testid, String filename) {
        return testCaseFileRepository.select(testid, filename);
    } 
    
    @LogExecutionTime
    public List<TestCaseDTO> getTestsByLabel(List<String> labels, int lastchecks) {

        //search by label
        List<TestCaseDTO> tests = testCaseRepository.selectByLabels(labels);

        //extend in parallel
        tests.parallelStream().forEach(
            test -> {
                test = this.addInjects(test);
                test = this.addChecks(test, lastchecks);
                test = this.removePasswords(test);
            }
        );
        
        return tests;
    }

    /**
     * hide passwords
     */
    private TestCaseDTO removePasswords(TestCaseDTO test) {
        if (test == null) return test;
        test.getInjections().stream().forEach(
            inject -> {
                inject.setConnectpassword(null);
                inject.setJwtpassword(null);
            }
        );
        test.getChecks().stream().forEach(
            check -> {
                check.setConnectpassword(null);
                check.setJwtpassword(null);
            }
        );
        return test;
    }

    /**
     * read all checks by bulk ID
     * @param bulkid Bulk ID
     * @return checks
     */
    @LogExecutionTime
    public List<TestCaseCheckDTO> getChecksByBulkId(String bulkid) {
        List<TestCaseCheckDTO> result = testCaseCheckRepository.selectByBulkId(bulkid);
        result.stream().forEach(
                check -> {
                    check.setConnectpassword(null);
                    check.setJwtpassword(null);
                }
        );
        return result;
    }

}