package org.opentesting.services.execution;

import java.time.LocalDateTime;

import org.opentesting.persistence.IndexRepository;
import org.opentesting.services.adapter.Adapter;
import org.opentesting.services.adapter.AdapterResolver;
import org.opentesting.services.pause.Pause;
import org.opentesting.services.scheduler.AsynTaskExec;
import org.opentesting.services.scheduler.TimerFactory;
import org.opentesting.util.OpenTestingConfig;
import org.opentesting.util.LogExecutionTime;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import lombok.extern.slf4j.Slf4j;

/**
 * central planing / management logic
 */
@Component
@Slf4j
public class TestManager extends TestAbstractHandler {    
 
    @Autowired
    private TimerFactory timerFactory;

    @Autowired
    private AdapterResolver adapterResolver;     

    @Autowired
    private OpenTestingConfig openTestingConfig;

    @Autowired
    private AsynTaskExec asynTaskExec;   

    @Autowired
    private Pause pause;

    @Autowired
    private TestCheck testCheck;

     /**
     * adapters might need timers
     */
    public void scheduleAdapterTimers() {
        try {
            for (Adapter adap : adapterResolver.getAllAdapter()) {
                for (String cron : adap.getRequiredTimerCrons()) {
                    timerFactory.createCheckTimer(adap.getAllServicenames(), cron, adap, asynTaskExec, testCheck);
                }
            }
        } catch (Exception e) {
            log.error("scheduleAdapterTimers failed with exception", e);
        }
    }

    /**
     * remove test id
     */
    @LogExecutionTime
    public String removeTest(String testid) {
        StringBuilder st = new StringBuilder();
        indexRepository.deleteByValue(IndexRepository.LABELINDEX, testid);
        st.append("index deleted");
        injectRepository.deleteByTestId(testid);
        st.append(", injects deleted");
        checkRepository.deleteByTestId(testid);
        st.append(", checks deleted");
        keyValueRepository.deleteByTestId(testid);
        st.append(", files deleted");
        testRepository.delete(testid);
        st.append(", test deleted");
        return st.toString();
    }  

    /**
     * pause injects and checks
     * @param byLabel by label or for all
     */
    @LogExecutionTime
    public void pause(boolean value, String byLabel) {

        //set pause
        pause.pause(value, byLabel);

        //adapter should know it
        final String finalLabel = byLabel;
        adapterResolver.getAllAdapter().parallelStream().forEach(
                adapter -> adapter.pause(value, finalLabel)                
        );
    }

    /**
     * auto-delete old data
     */
    @LogExecutionTime
    public void autodelete() {

        LocalDateTime maxAge = LocalDateTime.now().minusDays(openTestingConfig.getAutodelete());

        //cleanup old database checks
        checkRepository.deleteOlderThan(maxAge);

        //cleanup old database injects
        injectRepository.deleteOlderThan(maxAge);

        //cleanup old bulk ID index
        indexRepository.deleteOlderThan(IndexRepository.BULKIDINDEXCHECKS, maxAge);
        indexRepository.deleteOlderThan(IndexRepository.BULKIDINDEXINJECTS, maxAge);

        log.info("autodelete ("+openTestingConfig.getAutodelete()+" days) done");
    } 

}