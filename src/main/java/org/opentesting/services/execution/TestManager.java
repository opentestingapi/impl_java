package org.opentesting.services.execution;

import java.time.LocalDateTime;

import org.opentesting.persistence.IndexRepository;
import org.opentesting.services.adapter.Adapter;
import org.opentesting.services.adapter.AdapterResolver;
import org.opentesting.services.adapter.kafka.OpenTestingKafkaConsumer;
import org.opentesting.services.pause.Pause;
import org.opentesting.services.scheduler.AsynTaskExec;
import org.opentesting.services.scheduler.TimerFactory;
import org.opentesting.util.OpenTestingConfig;
import org.opentesting.util.ApplicationContextProvider;
import org.opentesting.util.LogExecutionTime;

import org.springframework.stereotype.Component;

import lombok.extern.slf4j.Slf4j;

/**
 * central planing / management logic
 */
@Component
@Slf4j
public class TestManager extends TestAbstractHandler {    
 
    private TimerFactory timerFactory;

    private AdapterResolver adapterResolver;     

    private OpenTestingConfig openTestingConfig;

    private AsynTaskExec asynTaskExec;   

    private Pause pause;

    private TestCheck testCheck;

    private OpenTestingKafkaConsumer openTestingKafkaConsumer;

    public TestManager(ApplicationContextProvider applicationContextProvider) {
        super(applicationContextProvider);
        timerFactory = applicationContextProvider.getBean(TimerFactory.class);
        adapterResolver = applicationContextProvider.getBean(AdapterResolver.class);
        openTestingConfig = applicationContextProvider.getBean(OpenTestingConfig.class);
        asynTaskExec = applicationContextProvider.getBean(AsynTaskExec.class);
        pause = applicationContextProvider.getBean(Pause.class);
        testCheck = applicationContextProvider.getBean(TestCheck.class);
        openTestingKafkaConsumer = applicationContextProvider.getBean(OpenTestingKafkaConsumer.class);
    }

     /**
     * adapters might need timers
     */
    public void scheduleAdapterTimers() {
        try {
            for (Adapter adap : adapterResolver.getAllAdapter()) {
                for (String cron : adap.getRequiredTimerCrons()) {
                    timerFactory.createCheckTimer(adap.getAllServicenames(), cron, adap, asynTaskExec, testCheck);
                }
            }
        } catch (Exception e) {
            log.error("scheduleAdapterTimers failed with exception", e);
        }
    }

    /**
     * remove test id
     */
    @LogExecutionTime
    public String removeTest(String testid) {

        //remove Kafka consumer
        openTestingKafkaConsumer.closeConsumer(testid);

        StringBuilder st = new StringBuilder();
        indexRepository.deleteByValue(IndexRepository.LABELINDEX, testid);
        st.append("index deleted");
        injectRepository.deleteByTestId(testid);
        st.append(", injects deleted");
        checkRepository.deleteByTestId(testid);
        st.append(", checks deleted");
        keyValueRepository.deleteByTestId(testid);
        st.append(", files deleted");
        testRepository.delete(testid);
        st.append(", test deleted");
        return st.toString();
    }  

    /**
     * pause injects and checks
     * @param byLabel by label or for all
     */
    @LogExecutionTime
    public void pause(boolean value, String byLabel) {

        //unique handling
        if (byLabel == null || byLabel.isEmpty() || byLabel.isBlank())  byLabel = Pause.ALLPAUSELABEL;

        //set pause
        pause.pause(value, byLabel);

        //adapter should know it
        final String finalLabel = byLabel;
        adapterResolver.getAllAdapter().parallelStream().forEach(
                adapter -> adapter.pause(value, finalLabel)                
        );
    }

    /**
     * auto-delete old data
     */
    @LogExecutionTime
    public void autodelete() {

        LocalDateTime maxAge = LocalDateTime.now().minusDays(openTestingConfig.getAutodelete());

        //cleanup old database checks
        checkRepository.deleteOlderThan(maxAge);

        //cleanup old database injects
        injectRepository.deleteOlderThan(maxAge);

        //cleanup old bulk ID index
        indexRepository.deleteOlderThan(IndexRepository.BULKIDINDEXCHECKS, maxAge);
        indexRepository.deleteOlderThan(IndexRepository.BULKIDINDEXINJECTS, maxAge);

        log.info("autodelete ("+openTestingConfig.getAutodelete()+" days) done");
    } 

}