package org.opentesting.services.execution;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

import org.opentesting.dto.TestCaseCheckDTO;
import org.opentesting.dto.TestCaseDTO;
import org.opentesting.dto.TestCaseInjectionDTO;
import org.opentesting.dto.TestCaseValidationDTO;
import org.opentesting.persistence.IndexRepository;
import org.opentesting.services.adapter.AdapterResolver;
import org.opentesting.util.ApplicationContextProvider;
import org.opentesting.util.LogExecutionTime;
import org.opentesting.util.exceptions.NotFoundException;
import org.springframework.stereotype.Component;

import lombok.extern.slf4j.Slf4j;

@Component
@Slf4j
public class TestScheduler extends TestAbstractHandler {

    private static final String FILENOTFOUND = "file not found: ";

    public TestScheduler(ApplicationContextProvider applicationContextProvider) {
        super(applicationContextProvider);
    }

    /**
     * schedule test
     */
    @LogExecutionTime
    public String scheduleTest(TestCaseDTO test) {            
        try {
            log.info("planing "+test.getId()+" with "+test.getInjections().size()+" injections and "+test.getChecks().size()+" checks");  

            //validation - check file existence
            checkFileExistence(test);

            //deactivated testcase needs to deactivate all injects and checks, to deactivate active timers
            inheritActivation(test);              

            //check activation
            StringBuilder message = new StringBuilder();
            StringBuilder ttlBuf = new StringBuilder();
            if (test.isActive()) {

                //send test case to all adapters for preparation (parallel)
                for (String warning : prepareAdapters(test)) {
                    message.append(warning+"\n");
                }

                //create inject timers
                createInjectionTimers(test, ttlBuf);       

                message.append("Test scheduled - here's the time-to-live of your injects:"+ttlBuf.toString());
            } else {
                message.append("Test stored, but inactive");
            }  
            
            //store test case as JSON for later usage (original, including injection timer IDs)
            this.storeTest(test); 

            //create label index to enable search
            for (String label : test.getLabels()) {
                indexRepository.insert(IndexRepository.LABELINDEX, label, test.getId());
            }

            //increase prometheus
            prometheus.incrementSchedule(test, true);
            prometheus.incrementTests(test);

            return message.toString();
        } catch (Exception e) {
            log.error("could not schedule test", e);

            //increase prometheus
            prometheus.incrementSchedule(test, false);

            return e.getMessage();
        }
    }

    private void createInjectionTimers(TestCaseDTO test, StringBuilder ttlBuf) {
        for (TestCaseInjectionDTO inject : test.getInjections()) {                       
            if (inject.isActive()) {
                //create timer and store ID
                String timerid = timerFactory.createInjectionTimer(test.getId(), inject, asynTaskExec);
                inject.setTimerid(timerid);                                
                if (inject.getSchedulets() == null) {
                    inject.setSchedulets(LocalDateTime.now());
                }
                ttlBuf.append("\n " + inject.getInjectid() + "=" + inject.getTimetolive() + " = " + inject.getSchedulets());
            }
        }
    }

    private void checkFileExistence(TestCaseDTO test) throws NotFoundException {
        for (TestCaseInjectionDTO inject : test.getInjections()) {
            checkFileExistenceInject(inject, test);
        }
        for (TestCaseCheckDTO check : test.getChecks()) {
            checkFileExistenceCheck(check, test);
        }
    }

    private void checkFileExistenceInject(TestCaseInjectionDTO inject, TestCaseDTO test) throws NotFoundException {
        if (inject.getSourcefile() != null && inject.getSourcefile().length() > 0) {
            String content = getFile(test.getId(), inject.getSourcefile());
            log.debug(content);
            if (content == null || content.length() < 1) throw new NotFoundException(FILENOTFOUND+inject.getSourcefile());
        }
    }

    private void checkFileExistenceCheck(TestCaseCheckDTO check, TestCaseDTO test) throws NotFoundException {
        for (TestCaseValidationDTO val : check.getValidations()) {
            if (val.getRequest() != null && val.getRequest().length() > 0) {
                String content = getFile(test.getId(), val.getRequest());
                log.debug(content);
                if (content == null || content.length() < 1) throw new NotFoundException(FILENOTFOUND+val.getRequest()); 
                checkFileExistenceCheckResponses(val, test);
            }
        } 
    }

    private void checkFileExistenceCheckResponses(TestCaseValidationDTO val, TestCaseDTO test) throws NotFoundException {
        for (String response : val.getResponse()) {
            if (response != null && response.length() > 0) {
                String content = getFile(test.getId(), response);
                log.debug(content);
                if (content == null || content.length() < 1) throw new NotFoundException(FILENOTFOUND+response); 
            }
        }
    }

    private void inheritActivation(TestCaseDTO test) {
        if (!test.isActive()) {
            test.getInjections().forEach(i ->  i.setActive(false));
            test.getChecks().forEach(c -> c.setActive(false));
        }
    }

    private List<String> prepareAdapters(TestCaseDTO test) {
        List<String> warnings = new ArrayList<>();
        AdapterResolver adapterResolver = applicationContextProvider.getBean(AdapterResolver.class);
        adapterResolver.getAllAdapter().parallelStream().forEach(
                    a -> {
                        try {
                            if (a != null) {
                                a.createRequiredComponents(test);
                            } else {
                                log.error("adapter is null");
                                warnings.add("adapter is null");
                            }
                        } catch (Exception e) {
                            log.error("could not initialize adapter "+a, e);
                            String servicename = "";
                            if (a != null) servicename = a.getServicename();
                            warnings.add("WARN "+servicename+": "+e.getMessage());
                        }
                    }
                );
        return warnings;
    }
    
}
