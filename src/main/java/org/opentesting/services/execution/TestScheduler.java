package org.opentesting.services.execution;

import java.util.ArrayList;

import org.opentesting.dto.TestCaseCheckDTO;
import org.opentesting.dto.TestCaseDTO;
import org.opentesting.dto.TestCaseInjectionDTO;
import org.opentesting.persistence.TestCaseFileRepository;
import org.opentesting.persistence.TestCaseInjectionRepository;
import org.opentesting.persistence.TestCaseRepository;
import org.opentesting.services.adapter.Adapter;
import org.opentesting.services.adapter.AdapterResolver;
import org.opentesting.services.prometheus.Prometheus;
import org.opentesting.services.scheduler.AsynTaskExec;
import org.opentesting.services.scheduler.TimerFactory;
import org.opentesting.util.LogExecutionTime;
import org.opentesting.util.OpenTestingConversion;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import lombok.extern.slf4j.Slf4j;

@Component
@Slf4j
public class TestScheduler extends TestAbstractHandler {


    @Autowired
    private TestCaseFileRepository testCaseFileRepository;

    @Autowired
    private TestCaseRepository testCaseRepository;

    @Autowired
    private AdapterResolver adapterResolver;  
    
    @Autowired
    private OpenTestingConversion openTestingConversion;

    @Autowired
    private TimerFactory timerFactory;

    @Autowired
    private TestCaseInjectionRepository testCaseInjectionRepository;

    @Autowired
    private Prometheus prometheus;

    @Autowired
    private AsynTaskExec asynTaskExec;

    @Autowired
    private TestInjection testInjection;

    /**
     * schedule test
     */
    @LogExecutionTime
    public String scheduleTest(TestCaseDTO test) {            
        try {
            if (test.getInjections() == null) test.setInjections(new ArrayList<>());
            if (test.getChecks() == null) test.setChecks(new ArrayList<>());
            log.info("planing "+test.getTestid()+" with "+test.getInjections().size()+" injections and "+test.getChecks().size()+" checks");  

            //validation - check file existence
            for (TestCaseInjectionDTO inject : test.getInjections()) {
                String content = testCaseFileRepository.select(test.getTestid(), inject.getSourcefile());
                log.debug(content);
                if (content == null || content.length() < 1) return "file not found: "+inject.getSourcefile();
            }
            for (TestCaseCheckDTO check : test.getChecks()) {
                String content = testCaseFileRepository.select(test.getTestid(), check.getExpectedfile());
                log.debug(content);
                if (content == null || content.length() < 1) return "file not found: "+check.getExpectedfile();                
            }

            //deactivated testcase needs to deactivate all injects and checks, to deactivate active timers
            if (!test.isActivation()) {
                test.getInjections().forEach(i -> { i.setActivation(false); });
                test.getChecks().forEach(c -> { c.setActivation(false); });
            }

            //store test case as JSON for later usage (original)
            testCaseFileRepository.insert(test.getTestid(), TESTCASESTORAGE, openTestingConversion.object2json(test));

            //store test case
            testCaseRepository.insert(test);

            //check activation
            String message = "";
            StringBuffer ttlBuf = new StringBuffer();
            if (test.isActivation()) {

                //send test case to all adapters for preparation (parallel)
                adapterResolver.getAllAdapter().parallelStream().forEach(
                    a -> {
                        if (a != null) a.createRequiredComponents(test);
                        else log.warn("adapter is null");
                    }
                );

                //create inject timers
                for (TestCaseInjectionDTO inject : test.getInjections()) {   
                       
                    if (inject.isActivation()) {
                        //create timer and store ID
                        Adapter adapter = adapterResolver.getAdapter(inject.getService());
                        if (adapter != null) {                            
                            timerFactory.createInjectionTimer(test.getTestid(), inject, adapter, asynTaskExec, testInjection);
                            if (inject.getCreatets() == null) {
                                ttlBuf.append(" " + inject.getInjectid() + "=" + inject.getTimetolive());
                            } else {
                                ttlBuf.append(" " + inject.getInjectid() + "=" + inject.getTimetolive() + "(" + inject.getCreatets() + ")");
                            }
                        } else {
                            log.warn("cannot create timer, unknown adapter: "+inject.getService());
                        }
                    }
                }             

                message = "Test scheduled - here's the time-to-live of your injects:"+ttlBuf.toString();
            } else {
                message = "Test stored, but inactive";
            }  
            
            //store injects with timer IDs (must be done for deactivated ones, too)
            testCaseInjectionRepository.insert(test.getTestid(), test.getInjections());

            //increase prometheus
            prometheus.incrementSchedule(test, true);
            prometheus.incrementTests(test);

            return message;
        } catch (Exception e) {
            log.error("could not schedule test", e);

            //increase prometheus
            prometheus.incrementSchedule(test, false);

            return e.getMessage();
        }
    }
    
}
