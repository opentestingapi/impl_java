package org.opentesting.services.prometheus;

import java.lang.management.ManagementFactory;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.opentesting.dto.TestCaseCheckDTO;
import org.opentesting.dto.TestCaseDTO;
import org.opentesting.dto.TestCaseInjectionDTO;
import org.opentesting.util.OpenTestingConversion;
import org.springframework.stereotype.Component;

import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.Gauge;
import io.micrometer.core.instrument.MeterRegistry;
import io.micrometer.core.instrument.Tag;
import lombok.extern.slf4j.Slf4j;

@Component
@Slf4j
public class Prometheus {

    public static final String CONCATENATOR = ".";
    public static final String LISTCONCATENATOR = "|";

    private static final String PROMETHEUS_TESTS = "tests";
    private static final String PROMETHEUS_SCHEDULE = "schedule";
    private static final String PROMETHEUS_INJECT = "inject";
    private static final String PROMETHEUS_CHECK = "check";
    private static final String PROMETHEUS_EXECUTION = "execution";

    private static final String GAUGE = "gauge";
    private static final String SUCCESS_TOTAL = "success=_total";
    private static final String TESTID_TOTAL = "testid=_total";
    private static final String LABELS_TOTAL = "labels=_total";
    private static final String TESTID = "testid=";
    private static final String LABELS = "labels=";
    private static final String SUCCESS = "success=";
    private static final String INJECTID_TOTAL = "injectid=_total";
    private static final String SERVICE_TOTAL = "service=_total";
    private static final String SERVICE = "service=";
    private static final String CHECKID_TOTAL = "checkid=_total";

    //Prometheus Registry
    private MeterRegistry meterRegistry;
    private Map<String,Counter> createdCounter = new HashMap<>();  

    //create tests
    private Set<String> activatedtests = new HashSet<>();
    private Set<String> deactivatedtests = new HashSet<>();

    public Prometheus(MeterRegistry meterRegistry) {  
        this.meterRegistry = meterRegistry;

        //create gauge for test cases
        Gauge.builder("e2e"+CONCATENATOR+GAUGE+CONCATENATOR+PROMETHEUS_TESTS, activatedtests, Set::size)
            .tag("active","true")
            .description("Active Test Cases").register(meterRegistry);
        Gauge.builder("e2e"+CONCATENATOR+GAUGE+CONCATENATOR+PROMETHEUS_TESTS, deactivatedtests, Set::size)
            .tag("active","false")
            .description("Inactive Test Cases").register(meterRegistry);

        //create gauge for memory and cpu
        Gauge.builder("e2e"+CONCATENATOR+GAUGE+CONCATENATOR+"usedmemory", ManagementFactory.getMemoryMXBean(),
            mb -> mb.getHeapMemoryUsage().getUsed())        
            .description("Used Memory").register(meterRegistry);        
        Gauge.builder("e2e"+CONCATENATOR+GAUGE+CONCATENATOR+"maxmemory", ManagementFactory.getMemoryMXBean(),
            mb -> mb.getHeapMemoryUsage().getMax())
            .description("Max Memory").register(meterRegistry);    
        
    }    

    /**
     * return meter registry for test checks  
     */
    public MeterRegistry getMeterRegistry() {
        return this.meterRegistry;
    }

    /**
     * create a new counter if required
     */
    private Counter createCounter(String metric, Iterable<Tag> tags) {
        return Counter.builder("e2e"+CONCATENATOR+"counter"+CONCATENATOR+metric)   
                .tags(tags)          
                .description("Counter: "+metric)
                .register(meterRegistry);
    }

    /**
     * create the store key
     * @param key name of the metric
     * @param tags use tags
     * @return key
     */
    private String createStoreKey(String key, Iterable<Tag> tags) {
        StringBuilder buf = new StringBuilder();
        buf.append(key);
        for (Tag t : tags) buf.append("#"+t.getKey()+"#"+t.getValue());
        return buf.toString();
    }

    /**
     * increment counter
     * @param key key (used for the name)
     * @param increment long value to increment the value
     * @param tags tags
     */
    public void incrementCounter(String key, long increment, Iterable<Tag> tags) {

        //create unique store key
        String storekey = this.createStoreKey(key, tags);

        //get counter
        Counter c = this.createdCounter.get(storekey);

        //create counter if required
        if (c == null) {
            c = this.createCounter(key, tags);            
            log.info("Prometheus Counter created: "+storekey+", actual size of the map: "+this.createdCounter.size());
        }

        //increment
        c.increment(increment);

        //store
        this.createdCounter.put(storekey, c);
    }

    /**
     * increment counter
     * @param key key (used for the name)
     * @param increment long value to increment the value
     * @param tags tags in key=value format
     */
    public void incrementCounter(String key, long increment, String... tags) {

        //create tags
        List<Tag> tagsList = new ArrayList<>();
        for (String tag : tags) {
            String[] data = tag.split("=");            
            tagsList.add(Tag.of(data[0], data[1]));
        }

        //run default method
        this.incrementCounter(key, increment, tagsList);
    }    

    /**
     * increment execution
     */
    public void incrementExecution(String name, String type) {
        this.incrementCounter(PROMETHEUS_EXECUTION, 1, "name=_total", "type=_total");
        this.incrementCounter(PROMETHEUS_EXECUTION, 1, "name="+name, "type=_total");
        this.incrementCounter(PROMETHEUS_EXECUTION, 1, "name="+name, "type="+type);
    }

    /**
     * increment test metrics
     * @param test TestDTO
     */
    public void incrementTests(TestCaseDTO test) {  
        if (test.isActive()) {
            this.activatedtests.remove(test.getId());
            this.activatedtests.add(test.getId());
            this.deactivatedtests.remove(test.getId());
        } else {
            this.activatedtests.remove(test.getId());
            this.deactivatedtests.remove(test.getId());
            this.deactivatedtests.add(test.getId());
        }        
    }

    /**
     * create labels list
     * @param labels labels to use
     * @return string representation
     */
    private String createLabels(List<String> labels) {
        return LISTCONCATENATOR+OpenTestingConversion.toString(labels, LISTCONCATENATOR)+LISTCONCATENATOR;
    }

    /**
     * increment schedule metrics
     * @param test TestDTO
     * @param success success
     */
    public void incrementSchedule(TestCaseDTO test, Boolean success) {  

        this.incrementCounter(PROMETHEUS_SCHEDULE, 1, TESTID_TOTAL, SUCCESS_TOTAL, 
            LABELS_TOTAL);

        String promlabels = createLabels(test.getLabels());

        this.incrementCounter(PROMETHEUS_SCHEDULE, 1, TESTID+test.getId(), SUCCESS_TOTAL, 
            LABELS+promlabels);
        this.incrementCounter(PROMETHEUS_SCHEDULE, 1, TESTID+test.getId(), SUCCESS+OpenTestingConversion.toString(success),
            LABELS+promlabels);
    }

    /**
     * increment inject metrics with success or not
     */
    public void incrementInject(String testid, TestCaseInjectionDTO inject, Boolean success, List<String> labels) {

        this.incrementCounter(PROMETHEUS_INJECT, 1, TESTID_TOTAL, SUCCESS_TOTAL, SERVICE_TOTAL, INJECTID_TOTAL, 
            LABELS_TOTAL);
        this.incrementCounter(PROMETHEUS_INJECT, 1, TESTID_TOTAL, SUCCESS+OpenTestingConversion.toString(success), SERVICE_TOTAL, INJECTID_TOTAL,
            LABELS_TOTAL);
        this.incrementCounter(PROMETHEUS_INJECT, 1, TESTID_TOTAL, SUCCESS_TOTAL, SERVICE+inject.getService().getType(), INJECTID_TOTAL,
            LABELS_TOTAL);
        this.incrementCounter(PROMETHEUS_INJECT, 1, TESTID_TOTAL, SUCCESS+OpenTestingConversion.toString(success), SERVICE+inject.getService().getType(), INJECTID_TOTAL,
            LABELS_TOTAL);

        String promlabels = createLabels(labels);

        this.incrementCounter(PROMETHEUS_INJECT, 1, TESTID+testid, SUCCESS_TOTAL, SERVICE_TOTAL, INJECTID_TOTAL, 
            LABELS+promlabels);
        this.incrementCounter(PROMETHEUS_INJECT, 1, TESTID+testid, SUCCESS+OpenTestingConversion.toString(success), SERVICE_TOTAL, INJECTID_TOTAL,
            LABELS+promlabels);
        this.incrementCounter(PROMETHEUS_INJECT, 1, TESTID+testid, SUCCESS_TOTAL, SERVICE+inject.getService().getType(), INJECTID_TOTAL, 
            LABELS+promlabels);
        this.incrementCounter(PROMETHEUS_INJECT, 1, TESTID+testid, SUCCESS+OpenTestingConversion.toString(success), SERVICE+inject.getService().getType(), INJECTID_TOTAL,
            LABELS+promlabels);
        this.incrementCounter(PROMETHEUS_INJECT, 1, TESTID+testid, SUCCESS_TOTAL, SERVICE_TOTAL, "injectid="+inject.getInjectid(), 
            LABELS+promlabels);
        this.incrementCounter(PROMETHEUS_INJECT, 1, TESTID+testid, SUCCESS+OpenTestingConversion.toString(success), SERVICE_TOTAL, "injectid="+inject.getInjectid(),
            LABELS+promlabels);
    }

    /**
     * increment Check metrics with success or not
     */
    public void incrementCheck(String testid, TestCaseCheckDTO check, List<String> labels) {

        this.incrementCounter(PROMETHEUS_CHECK, 1, TESTID_TOTAL, SUCCESS_TOTAL, SERVICE_TOTAL, CHECKID_TOTAL, 
            LABELS_TOTAL);
        this.incrementCounter(PROMETHEUS_CHECK, 1, TESTID_TOTAL, SUCCESS+OpenTestingConversion.toString(check.getSuccess()), SERVICE_TOTAL, CHECKID_TOTAL,
            LABELS_TOTAL);
        this.incrementCounter(PROMETHEUS_CHECK, 1, TESTID_TOTAL, SUCCESS_TOTAL, SERVICE+check.getService().getType(), CHECKID_TOTAL, 
            LABELS_TOTAL);
        this.incrementCounter(PROMETHEUS_CHECK, 1, TESTID_TOTAL, SUCCESS+OpenTestingConversion.toString(check.getSuccess()), SERVICE+check.getService().getType(), CHECKID_TOTAL,
            LABELS_TOTAL);

        String promlabels = createLabels(labels);

        this.incrementCounter(PROMETHEUS_CHECK, 1, TESTID+testid, SUCCESS_TOTAL, SERVICE_TOTAL, CHECKID_TOTAL, 
            LABELS+promlabels);
        this.incrementCounter(PROMETHEUS_CHECK, 1, TESTID+testid, SUCCESS+OpenTestingConversion.toString(check.getSuccess()), SERVICE_TOTAL, CHECKID_TOTAL,
            LABELS+promlabels);
        this.incrementCounter(PROMETHEUS_CHECK, 1, TESTID+testid, SUCCESS_TOTAL, SERVICE+check.getService().getType(), CHECKID_TOTAL, 
            LABELS+promlabels);
        this.incrementCounter(PROMETHEUS_CHECK, 1, TESTID+testid, SUCCESS+OpenTestingConversion.toString(check.getSuccess()), SERVICE+check.getService().getType(), CHECKID_TOTAL,
            LABELS+promlabels);

        this.incrementCounter(PROMETHEUS_CHECK, 1, TESTID+testid, SUCCESS_TOTAL, SERVICE_TOTAL, "checkid="+check.getCheckid(),
            LABELS+promlabels);
        this.incrementCounter(PROMETHEUS_CHECK, 1, TESTID+testid, SUCCESS+OpenTestingConversion.toString(check.getSuccess()), SERVICE_TOTAL, "checkid="+check.getCheckid(),
            LABELS+promlabels);
    }    
    
}
