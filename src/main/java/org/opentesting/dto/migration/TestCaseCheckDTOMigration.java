package org.opentesting.dto.migration;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.fasterxml.jackson.core.JsonProcessingException;

import org.opentesting.dto.TestCaseCheckDTO;
import org.opentesting.dto.api0dot1.TestCaseCheckDTOapi0dot1;
import org.opentesting.dto.api1dot0.TestCaseCheckDTOapi1dot0;
import org.opentesting.dto.api1dot0.TestCaseServiceDTOapi1dot0;
import org.opentesting.dto.api1dot0.TestCaseValidationDTOapi1dot0;
import org.opentesting.util.OpenTestingConversion;
import org.opentesting.util.exceptions.MigrationException;
import org.opentesting.util.exceptions.ValidationException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import lombok.extern.slf4j.Slf4j;

@Component
@Slf4j
public class TestCaseCheckDTOMigration {

    @Autowired
    private OpenTestingConversion e2EConversion;

    @SuppressWarnings("rawtypes")
    private Class[] versions = {TestCaseCheckDTOapi0dot1.class, TestCaseCheckDTOapi1dot0.class};

    @SuppressWarnings("unchecked")
    public TestCaseCheckDTO toLatest(String version, String json) throws JsonProcessingException, MigrationException, ValidationException {

        if (json == null || json.isEmpty()) return null;

        if (version.equals(versions[versions.length - 1].getSimpleName())) 
            return (TestCaseCheckDTO) e2EConversion.json2object(json, versions[versions.length - 1]);

        //migration to next version
        if (version.equals(TestCaseCheckDTOapi0dot1.class.getSimpleName())) {
            String newVersion = TestCaseCheckDTOapi1dot0.class.getSimpleName();
            TestCaseCheckDTOapi1dot0 newObj = api0dot1to1dot0(e2EConversion.json2object(json, TestCaseCheckDTOapi0dot1.class));
            log.info("converted 0.1 to 1.0");
            return toLatest(newVersion, e2EConversion.object2json(newObj));
        }

        throw new MigrationException("unknown conversion: "+version);
    }  

    @SuppressWarnings("rawtypes")
    public TestCaseCheckDTO toLatest(Class version, String json) throws JsonProcessingException, MigrationException, ValidationException {
        return toLatest(version.getSimpleName(), json);
    } 
    
    /**
     * migrate from 0.1 to 1.0 (uploads only, no instance/database migration required)
     * @throws ValidationException
     */
    TestCaseCheckDTOapi1dot0 api0dot1to1dot0(TestCaseCheckDTOapi0dot1 input) throws ValidationException {
        TestCaseCheckDTOapi1dot0 result = new TestCaseCheckDTOapi1dot0();
        
        result.setActive(input.isActivation());
        result.setCheckid(input.getCheckid());
        result.setChecks(input.getChecks());
        result.setInjects(input.getInjects());
        result.setMandatory(input.isMandatory());
        result.setMaxwaittime(input.getMaxwaittime());
        result.setResult2random(input.getResult2random());

        //service
        result.setService(api0dot1to1dot0Service(input));

        //validation
        Map<String,String> inputval = new HashMap<>();
        inputval.putAll(MigrationHelper.parameterToMap(input.getServiceparam(), ";"));
        List<TestCaseValidationDTOapi1dot0> validations = new ArrayList<>();
        TestCaseValidationDTOapi1dot0 val = new TestCaseValidationDTOapi1dot0();
        val.setOrder(1);
        if (inputval.get("cql") != null) val.setRequest(inputval.get("cql"));
        if (inputval.get("sql") != null) val.setRequest(inputval.get("sql"));
        val.setResponse(List.of(input.getExpectedfile()));
        val.setType(input.getExpectedtype());
        validations.add(val);
        result.setValidations(validations);

        return result;
    }

    private TestCaseServiceDTOapi1dot0 api0dot1to1dot0Service(TestCaseCheckDTOapi0dot1 input) throws ValidationException {     
        return MigrationHelper.api0dot1to1dot0Service(input.getService(), input.getConnectstring(), input.getConnectuser(), 
            input.getConnectpassword(), input.getJwtuser(), input.getJwtpassword(), input.getServiceparam());
    }
    
}