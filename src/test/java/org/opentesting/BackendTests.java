package org.opentesting;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

import org.opentesting.dto.TestCaseCheckDTO;
import org.opentesting.dto.TestCaseDTO;
import org.opentesting.dto.TestCaseInjectionDTO;
import org.opentesting.services.execution.TestManager;
import org.opentesting.util.OpenTestingConversion;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.util.Assert;

import lombok.SneakyThrows;
import lombok.extern.slf4j.Slf4j;

/**
 * Backend Tests
 */
@SpringBootTest
@Slf4j
class BackendTests extends TestDataGenerator {

	@Autowired
	private TestManager testManager;

	@Autowired
	private OpenTestingConversion openTestingConversion;

	@Test
	@SneakyThrows
	void testTestCaseRepo() {
		//database will sort labels, please take care in this test
		TestCaseDTO tc = createEmptyTest();
		testManager.storeTest(tc);

		TestCaseDTO tc2 = testManager.getTest(tc.getId());
		testManager.removeTest(tc.getId());

		Assert.isTrue(OpenTestingConversion.toStringDatabase(tc.getLabels()).equals(OpenTestingConversion.toStringDatabase(tc2.getLabels())), "labels incorrect");
		log.info("##### testTestCaseRepo done #####");
	}

	@Test
	@SneakyThrows
	void testTestCaseInjectionRepo() {
	
		TestCaseDTO tc = createEmptyTest();
		TestCaseInjectionDTO inject = this.createInject();
		tc.setInjectioninstances(List.of(inject));
		testManager.storeTest(tc);

		TestCaseDTO tc2 = testManager.getTest(tc.getId());
		testManager.removeTest(tc.getId());
		TestCaseInjectionDTO tci2 = tc2.getInjectioninstances().get(0);

		log.info(openTestingConversion.object2json(tci2));

		Assert.isTrue(tci2.isActive(), "injection incorrect");
		Assert.isTrue(tci2.getTimerid().equals(inject.getTimerid()), "injection incorrect");
		Assert.isTrue(tci2.getReplacements().size() == inject.getReplacements().size(), "replacements incorrect");
		log.info("##### testTestCaseInjectionRepo done #####");
	}

	@Test
	@SneakyThrows
	void testTestCaseCheckRepo() {

		TestCaseDTO tc = createEmptyTest();
		TestCaseCheckDTO check = this.createCheck("check1");
		tc.setCheckinstances(List.of(check));
		testManager.storeTest(tc);

		TestCaseDTO tc2 = testManager.getTest(tc.getId());
		testManager.removeTest(tc.getId());
		TestCaseCheckDTO check2 = tc2.getCheckinstances().get(0);
		
		Assert.isTrue(LocalDateTime.now().isAfter(check2.getStartts()), LocalDateTime.now()+" > "+check2.getStartts());
		Assert.isTrue(LocalDateTime.now().isBefore(check2.getTargetts()), LocalDateTime.now()+" < "+check2.getTargetts());
		Assert.isTrue(check2.getRandomdata().getRandomdata().get("#hallo#").equals("Hallo Welt!"), "random data failed");
		Assert.isTrue(check2.getBulkid().equals(check.getBulkid()), "bulkid failed");
		Assert.isTrue(check2.getSuccess() == null, "success flag failed");
		Assert.isTrue(check.getInjects().get(0).equals(check2.getInjects().get(0)), "injects incorrect");
		Assert.isTrue(check.getChecks().get(0).equals(check2.getChecks().get(0)), "checks incorrect");
		Assert.isTrue(check.getResult2random().get(0).equals(check2.getResult2random().get(0)), "result2inject incorrect");
		Assert.isTrue(check.getTraceid().equals(check2.getTraceid()), "traceid incorrect");
		log.info("##### testTestCaseCheckRepo done #####");
	}

	@Test
	@SneakyThrows
	void testTestCaseFileRepo() {
		String testid = "testid1";
		String filename = "testid.json";
		String content = "{ \"key\" = \"value\" }";
		testManager.storeFile(testid, filename, content);
		String content2 = testManager.getFile(testid, filename);
		testManager.removeTest(testid);
		Assert.isTrue(content.equals(content2), "filecontent incorrect");
		log.info("##### testTestCaseFileRepo done #####");
	}

}
